# **项目启动文档：高并发达人监控与视频下载系统 (代号: Dragonfly)**

**版本:** 1.0
**日期:** 2025年8月14日
**协作方:** 用户 & Gemini

## 1. 项目愿景与核心目标

此项目的核心目标是构建一个稳定、高效、可扩展的自动化监控系统。它能够7x24小时不间断地监控超过200个指定的达人社交媒体账号（抖音、快手），在发现新发布的视频后，能在30秒内按预设优先级进行下载，并立即发送通知。

---

## 2. 关键需求指标 (KPIs)

- **监控容量 (Capacity):** 支持同时监控 **200+** 达人账号。
- **监控频率 (Frequency):** 每 **30 秒** 对所有账号进行一次更新检查。
- **响应时间 (Response Time):** 从检测到新视频到发送通知，延迟应小于 **30 秒**。
- **运行模式 (Uptime):** **7×24 小时** 持续稳定运行。
- **并发处理 (Concurrency):** 系统必须支持高并发的账号检查与视频下载。
- **核心功能 (Features):** 支持为下载任务设置 **优先级**，并严格按优先级顺序执行下载。

---

## 3. 最终技术选型 (Tech Stack)

经过讨论，我们确定采用以下技术栈以最高效地达成目标：

- **编程语言:** **Node.js (使用 TypeScript)** - 兼顾开发效率、类型安全和强大的异步 I/O 能力。
- **核心框架:** **NestJS** - 提供开箱即用的项目结构、依赖注入和模块化，极大加速开发进程。
- **任务队列:** **BullMQ** - 基于 Redis，高性能、稳定且原生支持优先级队列，完美契合需求。
- **定时调度:** **`@nestjs/schedule`** - NestJS 官方模块，优雅地实现定时任务。
- **数据存储/队列后端:** **Redis** - 作为 BullMQ 的后端，并可用于高速缓存。
- **数据持久化 (可选，建议):** **PostgreSQL** 或 **MongoDB** - 用于存储已下载视频的元数据、监控日志等。
- **进程管理器:** **PM2** - 确保应用在生产环境中稳定运行、自动重启和负载均衡。

---

## 4. 系统架构设计

我们将采用经典的 **生产者-消费者** 架构，通过任务队列实现服务解耦，确保系统的可扩展性和弹性。

```
[定时调度器 (Scheduler)]
       |
       |  (每30秒)
       |
       └───> [批量生成200+个“检查任务”] ───> [ 检查任务队列 (Checker Queue) ]
                                                         |
                                                         | (并发消费)
                                                         |
                                                 [ 检查工作池 (Checker Workers) ]
                                                         |
                                                         | (发现新视频)
                                                         |
       ┌─────────────────────────────────────────────────┘
       │
       │
       └────> [生成“下载任务”并设定优先级] ───> [ 下载任务队列 (Downloader Queue) ]
                                                             |
                                                             | (按优先级并发消费)
                                                             |
                                                     [ 下载工作池 (Downloader Workers) ]
                                                             |
                                                             | (下载完成)
                                                             |
                                                             └───> [发送通知] & [数据持久化]
```

---

## 5. 开发任务分解 (Action Plan)

我们将按以下步骤，循序渐进地构建整个系统：

1.  **步骤一：环境搭建与项目初始化**

    - 安装 Node.js, Redis, NestJS CLI。
    - 使用 `nest new` 创建项目。
    - 集成并配置 `@nestjs/bull` 和 `@nestjs/schedule` 模块。

2.  **步骤二：实现调度器与任务生产**

    - 创建一个 `CheckerService`。
    - 使用 `@Cron` 装饰器实现一个每 30 秒运行一次的调度器。
    - 在调度器逻辑中，向 **BullMQ** 的“检查任务队列”中批量添加任务。

3.  **步骤三：实现检查工作池与任务消费**

    - 创建一个 `CheckerConsumer` 来处理“检查任务”。
    - 在该消费者中，编写模拟的 API 请求逻辑。
    - 当“发现”新视频时，将一个带有下载链接和优先级的“下载任务”推送到“下载任务队列”。

4.  **步骤四：实现下载工作池与优先级处理**

    - 创建一个 `DownloaderConsumer` 来处理“下载任务”。
    - 编写实际的视频下载逻辑。
    - 验证 **BullMQ** 是否严格按照设定的优先级来处理任务。

5.  **步骤五：实现通知与数据持久化**

    - 在下载成功后，触发通知逻辑（初期可以是简单的 `console.log`）。
    - （可选）集成数据库模块（如 TypeORM），将视频元数据存入数据库。

6.  **步骤六：配置、部署与监控**
    - 使用 `.env` 文件管理环境变量（如 API 密钥、数据库密码）。
    - 编写 `pm2` 的配置文件 (`ecosystem.config.js`)。
    - 部署并启动应用。

---

## 6. Gemini 的角色与协作方式

我将作为您的 **技术副驾 (Technical Co-pilot)** 和 **结对编程伙伴 (Pair-programming Partner)**，为您提供以下支持：

- 根据每个开发步骤，提供具体的 **NestJS 代码示例**。
- 解释核心概念（如依赖注入、装饰器、任务队列原理）。
- 协助您 **调试代码** 并分析潜在问题。
- 提供关于 **最佳实践** 和 **性能优化** 的建议。
- 回答您在开发过程中遇到的任何技术问题。
- 尽可能的用中文注释

---
